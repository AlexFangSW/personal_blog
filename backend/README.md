# Coding notes backend
## Development
### Run locally
Install `goose` and `swaggo`
```bash
go install github.com/pressly/goose/v3/cmd/goose@latest
go install github.com/swaggo/swag/cmd/swag@latest
```
Install dependences
```
go mod download
```
Run
```bash
./scripts/run.sh
```
### Docker
```bash
./scripts/docker_build.sh
```
```bash
./scripts/docker_run.sh
```

## Tech stack
- Language: **GO**
- Server: **net/http** ( Routing is done with `net/http.ServeMux`)
- ORM: **None**, this project uses `database/sql` with **raw sql queries**.
- Database: **SQLite**
- Database Migration: **[goose](https://github.com/pressly/goose)**
- API documentation: generated with **[swaggo](https://github.com/swaggo/swag)**

## API Documentation
### Overview
APIs are seperated into **PUBLIC** and **PRIVATE**, 
**PUBLIC** APIs can be access by anyone, while **PRIVATE** APIs 
needs **JWT** token.

-   <details>
    <summary>Blogs API</summary>

    - **Public API** ( Access blogs that are visible or not soft deleted):
        - List
            - all
            - filter by topic id (allow multiple ids)
            - filter by topic and tag ids (allow multiple ids) 
        - Get by id
    - **Private API** ( Needs JWT token, have access to all blogs regarding visibility or soft delete status )
        - Create
            - auto generate id
            - with specified id
        - List
            - all
            - filter by topic id (allow multiple ids)
            - filter by topic and tag ids (allow multiple ids) 
            - simplified
                - only includes necessary fields to verify change, such as: **content_md5**, **tag.slugs**, **topic.slugs**...etc.
                  (used by **SyncTool**)
        - Update
        - Delete
            - soft delete
            - restore soft deleted blog
            - delete

    </details>

-   <details>
    <summary>Tags API</summary>

    - **Public API**
        - List     
            - all
            - by topic id ( tags related to blogs under a specific topic )
    - **Private API**
        - Create
        - Update
        - Delete

    </details>

-   <details>
    <summary>Topics API</summary>

    - **Public API**
        - List     
    - **Private API**
        - Create
        - Update
        - Delete

    </details>

-   <details>
    <summary>Auth API</summary>

    - **Public API**
        - Login ( returns **JWT** token on success )
        - Logout ( removes **JWT** token from database )
        - Auth check ( mostly unused, checks if jwt token is valid )

    </details>

### Details
> [Swaggo](https://github.com/swaggo/swag) (auto genrate swagger.json) dosn't support JWT auth yet. 
> The 'Authorization' header is placed as a headers param.
- Swagger Doc: [swagger.json](./docs/swagger.json)

## Code Architecture.
- **Entities**
    - Basic structs
- **Models**
    - Focuses on making sql queries on specific tables 
    - Including:
        - blogs
        - tags
        - topics
        - blog_tags (many to many)
        - blog_topics (many to many)
- **Repository**
    - A interface for CRUD operations on base tables such as: blogs, tags, topics
    - Automaticly maintains many-to-many tables: blog_tags, blog_topics
- **Handlers**
    - Core app logics, uses repository layer for CRUD operations

## Database
- [Entity relationship diagram](./docs/pics/entity-relation-diagram.png) (Generated by DBeaver)

## Progress
- Blogs
    - [x] Basic CRUD operations
        - List operations will return empty 'content' field to reduse size.
    - List filters
        - [x] By topic ids
        - [x] By topic and tag ids
        - [x] Option to return simple output with tags and topics as slugs (orignaly returns full struct of tags and topics)
            - This reduces the size from 1M to about 310K on 1000 blogs with 2 to 3 tags and topics
    - [x] md5 to check if content is the same.
- Tags
    - [x] Basic CRUD operations
    - List filters
        - [x] By topic id ( in relation to blogs under a specific topic )
- Topics
    - [x] Basic CRUD operations
- Auth
    - [x] Rate limit

## Tests
- repository integration test
    - blogs
        - [x] Basic CRUD
        - [ ] create blogs with specific ID
        - List filters
            - [x] By topic ids
            - [x] By topic and tag ids
    - tags
        - [x] Basic CRUD
        - List filters
            - [ ] list tags by topic id
    - topics
        - [x] Basic CRUD
- Auth util unit test
    - [x] jwt helper
    - [x] auth helper
- handler unit test
    - [ ] blogs
    - [x] tags
    - [ ] topics

## CLI Tools
### SyncTool
> **This is build and placed alongside server binary in the docker image**

I want to use my own editor to write notes.

This is a tool that can sync my notes to the server.

The notes should be organized like `dummyData` folder
- A **meta.yaml** containing tags and topics
- **blogs** folder containing blogs with frontmatter

After the first sync, an **ids.json** file will be created, which maps blog filenames to their ids.
This prevents blog ids from changing if we lost the database and need to sync from scratch.

#### About referential integrity
If some blog's frontmetter has a tag or topic that doesn't exist,
it will be recorded, logged out and written to a file (**data-inconsistency.json**), after which the sync process will be terminated.
Only after passing the validation process will the data be synced to the server.

### User register
> **This is build and placed alongside server binary in the docker image**

This project is only used by one person, with no intention of saving other user's stuff.

And because of this, there is no api for registoring a new user.

Only someone with direct access to the database can register.

#### Functions
- CRUD for user table, directly operates on the database.

## TODO
- Better error handling for sync tool
